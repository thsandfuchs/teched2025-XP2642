## Add shared Environment Variables across jobs here ##
env:
  "CLUSTER_CONTEXT": "${{ inputs.CLUSTER_CONTEXT }}"
  "IDP": "${{ inputs.IDP }}"
  "NAMESPACE": "${{ inputs.NAMESPACE }}"  

  RUNTIME_ACTION: "apply"
  CONFIG_DIRECTORY: "./exercises/ex1/k8s-data/"
  PATH_TO_TFSCRIPT: "./exercises/ex1/k8s-data/"  

"jobs":
  "apply-manifest":
    "runs-on":
    - "ubuntu-latest"
    "steps":
    - "name": "Check out Git repository"
      "uses": "actions/checkout@v4"

    - "name": "Install Helm"
      "uses": "azure/setup-helm@v4"
    - "name": "Setup Kube Context - xp264-000"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQUpjRnZWQ1hnbXljc3pDSHMwVVRzZ1V3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVeE1EQTFNakF6T1RVMldoY05NelV4TURBMU1qQTBNRFUyV2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTEZ2CnY1S0dSNXJBakRmS1BlMGVVaG13K2hjNjFQb09xb0tocWJNNEYzZWpia29CU3pZL09BaHR1ZEdWUysreFhvTW4KUk5VYUNMV0VMbVhjN0x3UUZiYjBQTzIySlo4emRVNGJ5U0tZUWxvSVRodERHTGY1T1d1Uit4WXRaRzdWaTVhZApvSHN2ZisxRTRCdnA5SmhISmdySm1KdlVBRW84K1dwU2VwNHlJWTZLRFJMczR0V0w2bFlaTkw2RnFjNWJRYnMwCjFtRFNXcDJkRjV1c2k5SHJUcXRQMS9JU1JmSVN3dlRBYnh4OWVXU3BvYklmejJwQncvdnRIcEdQSTV2ZnVaMUQKeTdoTVdkNnFLVWQrZmRVWXV4L1dQMS91YStvY1VqUXZYeFIyeERlSjF3TlVCczViV043citHT1BpNGFvVmh0cQpmOEc2MFdsZ2lUM1gyZ2ZCN3BkbWFQZHl5N3NFZkcwTmdsejdBYXlwZG4vV2VxZitIcFUrRmFSZjZPdXlmSENXCkMyNWluM0hDeko3Wmp3Y0dsVVpwOGQ1VHVITVVNT28yQndoRG5sWGRsVnZTamN4Mk9tTVZoUW5xM2xhWXdtZXEKVURXcldON3dqUE5hUXl5NVBmQUJ2ZGorKzBVVUpndWt3dDRaNENpaVR6aG8wS3hpTytrN0xycC9iSSszUFFJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVwMWxMbDBRY1U4aGJoeGZCVEd3Ylo4YXV2Y3N3RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQUVlOG5MN3AKRGhiSUJVN3Y1ZWRTTVcvV3NDL3pOaFA0SC83LytVc2t2c1BEYWJDZjJpNW9SWW5uOU95NkRQcjhqc0wrVTJ0bQovRGpKcVROZWxrRi9BV0NISk93Zk8yVUgwRm1zejJZc3ZJeTA0Q05DSnUwTHlWRFRYYlI4Mm1WZjI5MDZJR0UwCmVlS1JuZVhQOWpmZ1NhWklVMjhvK0RmTHJ1V3JEME9tbHQ2U1ZMSHdxU3VjR2xBN1FJWjI2eFJWS1RZM2tkZXAKVnpheVRLTFpiZzZQVjFJUUwzUjlrWjNNQWRwL0l6L05YMlZJSStYZnU4clh3ZXJGS3VuN3ZIT3g1NU9abWxPVwpxcWhQMHFzdGhwQUNjSXpsWEx1RFFFUEtlVGNick1WQk9CSEhheVhGNTl5V3NjbStJL1o4OHNpc3dYdXF6VmdVCk1XaEhDQUM2TFk3UkkyQWt3a1RobFMvRy81UnpOTFI5UkFmMitwRGhpeXNwT2JhbzRTVGxuRmhPL3hPMXBPSTgKUFo2VGRiY2tIMmk2cmJYTXVkTmkrdmtac2lWaHFhTFpNZ3NvVmlaaTZlTzNSRENuOUVLaTBBUmlSdnUzRlExZQp6RmdhazNwY3kwZitDSU5aNitZVmZxdHM3eUZ4NkVQaXQyVTZGbC9QbWlCNUc5SVgvdUNMZVFMNStnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.c-4d2de7e.kyma.ondemand.com"},"name":"garden-kyma--c-4d2de7e-external"}],"contexts":[{"context":{"cluster":"garden-kyma--c-4d2de7e-external","user":"garden-kyma--c-4d2de7e-external"},"name":"garden-kyma--c-4d2de7e-external"}],"current-context":"garden-kyma--c-4d2de7e-external","kind":"Config","users":[{"name":"garden-kyma--c-4d2de7e-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-622af3fe-a2f5-4fdd-a05f-73e343aec2a5\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./xp264-000.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - japanese-east"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQU9DemdDNWw0TmRHNUhxSi9ieTJnRGd3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVd09USXpNakV3TmpNd1doY05NelV3T1RJek1qRXdOek13V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTGl2Cmp2Mkt3RklIckRGbC9pQlBFOGVxUDVsZ2dEdHJ3bUtHUFQyTVNEaTBDWnhjUVFwbVpseUs1ZlREQzVrUmdQYVMKUmZJN2hSMVNCVW5BMmN6ZUxJU0NlTTAwMnI3ZVJyZ0FIUUlYWi85SkR2aDM2OFhJSDdXazdVY1F6TU9DbW13ZwpmNDBLYVNRUGVSN1hmNnhlTGc5SFVGQnNNZ1dDcE1EYmZ2dnE1d2VDdVRnS0d2eTZlVlVQaXBoTGIyMTFpbURFCk5xS1N2RW1JeThPUTdBUWozVzdsNVJvbTFSSVBQUWVHaXBnQ3NaVE1oT2JnYStPYVNzS1pFZlBWQnltWjI1UE0KOW5Nd0RnT25mSzJnMlA3bzQvdEFRdjg3MWU0am5nTUdPVjhncmVoVGdCN3VnVzFsdkRXNTBOU3RDQmxLMjlRTwpwVHdCbXh3R1lMU1VyU0hBWFhoUUNUS1IrcmV3VEJSM3hIMk5uaGl4dFNXdkFOUXAzZDNocjVnSE1ZQVN5M3VvCjRYdFZTRStvTnlyRVV1RGhicVJmK3hyRzlSdndidHNWZkNrMlNKYTEwdGN1R1VaQ1BJc2VXTG9nYzRXRHE3M3cKRDhENUQ3Y1BoYjBrZ1UzbmhWTHphaGhCelUwOWM1LzVnRUNYVC9pQk0wcmZBRytTNUkyQ1g0ZkRvTHFaVHdJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVrQ1VaZjE1RFY4ZkNmUDFMNVhBWXFEa29JY013RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQURxNnRrcm0KblhJU1lvbVhwR1lSRFBrS2x4RVptVVRPQnpCL1lFNXVxMkdVclNwVDdKRkFuZmkrKzhmZDRCaGZPM2pMdmsyZApmL1ExL0dKT1g2aVVTMGJIUnlrNFo0SHZUN1l0bkJ6NkVlWFBBWGMyMmZpUjY3b0ZsdXFoUmRsOXhGdUFaWTlJCnFCem1ZNmVOdXJKcStBL3VLZG1xakFXNTRhTXhZWGtERWFFaEszYVV4Ukx1RkMrdjFEQ2RCbWdGNnJTUnQxZHMKTUtJM1ZzTFRxTG1hU0ZQdURad3lYTDNsY0xtL2F5UWFMNlQ5V25QT1o4MWJBejdwMVBRU004RVZYS1o1UjV2RQpKWUFGWUw4MWN3ZEEwWW4wak5JdHA4ZDNpMm9wenMzMkk2K2F4Sjh0Q1I5amZhTXh2M3p6Z0RxZTJvQ0NQTGZ4Cm04dks3TFFGbXI4SU1GL0kycDhTYVNCeVlpYkI0OVNaQ1hvU3hJYTZqaEFTaEFUZzkvSENReXZ5WkhGUEtwbjEKdVorQzMrVWd3YkhkbXJBYjRQaGNJSHJuclE3T3VJMlc0VUt5TEZvTzNTL3k1eVU5RE9XZmZ6dU1KMXRmaDNjWQplTmNZa1B4R0svUnFpN0h4VUtwWFM5emJIM2pqeWg4aTltRE9xZ1NmTFdKcldUZVBYMndUT3l1UHNRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.c-99567a9.kyma.ondemand.com"},"name":"garden-kyma--c-99567a9-external"}],"contexts":[{"context":{"cluster":"garden-kyma--c-99567a9-external","user":"garden-kyma--c-99567a9-external"},"name":"garden-kyma--c-99567a9-external"}],"current-context":"garden-kyma--c-99567a9-external","kind":"Config","users":[{"name":"garden-kyma--c-99567a9-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-2a6fe480-ac84-4751-ad37-56ec2a493932\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./japanese-east.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - us-east"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRTDkzRW45WGtQd2d0YW1jYmsrK3VmVEFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRBNE1UVXhNakl3TkRkYUZ3MHpOVEE0TVRVeE1qSXhORGRhTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUFwWEg4ClJSQlFsSUVmbGpWWVRUemdoZ0Z5UURwTjlUTnpOL2RGeGxDWk1VUWthS1FTZFByWEtGTXR2QlRRa0lnb0VvOVYKdXBZNU9WTkNDT0h1T3UvMWZwRkVwS1ZHQUJ6c3ZsSFVpQjhUZ09hcVR4OXQ4UkxTRkRxaGF3anZBWVBTQ1U4ZgpoN3NpOEUyVzBqT0E0MVhJUG9zWXN4K1BSekFVQnNSZURQT2huU3R6amdXWVhJbDc3WTZMNk1mNk0vSlpNeFFnCkdlZDFhMGtJWDI5d3J0cWJ6bnB0WmZPSHhkN0tmT0xCM0JLZzNUckVsME52QjNOMFVLV1ZpaUwwSjZrcmpsRmIKbEh3RUJxejJ0UlFJR08remZhdE9KdXJmcklST04wR21LYWttVEFzalNqei9KMW9SeVJzTHZoT0w5c3VTT0UrSApMcDNmZXdWNmkrZGgvT0Erc2tMMXRBWWdFWTVwbGV4cXVXVklvbGV2OURsSDBsTWxpMUpEY3hyUUtTclZrRy9hClY3bThWTjg4SWNBWmMrVTQwMmZKYytDUlFvQzh0c1VjWnY2TDk1K2pvL0VLQTQ3ZVJXdEp5czdkaGlNd2QzMmoKalZsaEw0anFVdDVCQnlPbUEvbnc2Vk9qdnU2R0lUNzlsTjBBZzB4dDJKdmpQWDJpL0Z2U2NyNHgrMG1IQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCUkxtNTVDK1VvVG9sSit1UGFLdWxMTjVsT3VzekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBVjNtVXhVTkQKRDhkdHV3Mmk5UnFLMWRnZUVPK1JzRmdONnp5OWV4QjU3aHRDT0tMVXJZaHBXcVFsWUIzbktaZWJCMEo4b21hdwoyS0E1dGdrUUJNdW1zYkQwVEl3bUNpakNxU0J4TDJBZ2tKbXhnVExWbmdmeW14NURFdVIvaWw2SlJBUC9HZ2NvCndpSnlwSGtHRVFOdTZmRW1CbEZnVlQ3aFdENTVSSFdwSWJTOFhYd1JGTWlDa3E0NU1heVhGeGFBOUdVNFNhcmwKeDhsRXlTem1Ja0RTcm90V0pXM2lwVVZqM0IyR3BxandtdlFuL2Z4V2dadUdvVVd2NEp3Z2FYd2UzL3hOangvNQozMVlqTmZ1NllnejBHeUw4NEgwRlo4Ym5KWmszekNLcGd3L1JwZ2UxSFg1MVE5bnVkMW5SS1hwOThYZ0VnY1ExClJIeG5LU2ZqQUtPbVhmeFltQ1d0aHR6T1dZbldyTWllWWNqbFg1b2VML1h6NW80R2FPRWowUHJ6MWxFcFZvaGIKclU0bkRwV01xQ0xicTlYL3NJTFlGY2o4alduVUYxTUFmbWg4aUJJMEZqbnk3bGU3bkpRazJEd2c1MEY4eDNYUgpROGdKcE9od3NRSUJEOWtwWnNTN1liZU1LeEpHaWtLcGhMd0xQSUlTNmJzQ1BlejRTajFjcjk0cQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==","server":"https://api.ca15e0c.kyma.ondemand.com"},"name":"garden-kyma--ca15e0c-external"}],"contexts":[{"context":{"cluster":"garden-kyma--ca15e0c-external","user":"garden-kyma--ca15e0c-external"},"name":"garden-kyma--ca15e0c-external"}],"current-context":"garden-kyma--ca15e0c-external","kind":"Config","users":[{"name":"garden-kyma--ca15e0c-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-dbe7346b-88da-430a-8777-4f6aa3e22b5e\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./us-east.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - uk-south"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQUt3bWpnd1VwQTQ5Rkw2Mkp3Zm56Y2d3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVd09USXpNVE15TlRReldoY05NelV3T1RJek1UTXlOalF6V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTVliCk5pMmg2WVpUZjZyWlB3a0FIbmFLR1RReVU4Uk40NzFxOVhnTzFLcHM5K2pWVGRoTVVsTzd5U2hGRGM3dExIYkUKL2NPa3hYdTZYSFRSamR6SkttVUhVZDNwM2Y1K2NoMGw2b0p4YnRiZFByT1A1VSt6endTM2g4U1lVbU9vM0g1NwplQlk2TUIxVlRWSUxGSzM3KzE5V3dlbDZ4cTJ1TWdBTWVnYWhKaUNXVWtIdmJJRWtvN255SGUvLzIwUW4zVExuCmhtSExBZVNBQXEwbWZ6YlVkV1I3NU9xVzZNNUk1bHI2NHRxdzZDVmlvUGtiRGpBTUlDcWpMMlIrclVaMXNWQlQKMmhQT3FsSWRtV0l0U2hoUjIrVmtmR2s0T2FjeDFhWlYxeWNveTJIYngzY1BMaXNsWDFZMXprMGNBTThuc1cyego5cTBZNmZqeVpXd3FrMklrK0srSVNlSitNbDBSNTdQNXdQZmlFNlZkRjk5YWJtRFUzZjZyYUlSaDZidVRuSFlPClVKZHZHdUs3dTd0ZFRPQXQxVUV1UjBmRmdSZjRIZ296ejY4OXltWUN1Z0FtY095b1dkQnR0eTBieWt6QXdKUWIKQUtKcE5NVXhRYURpQkhkK1piSzJPbHhBdCttTzNxZkJMaWttRDZxNnJrTXNXUEF5WWlVSSt1TW9PRE1KUVFJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVPRmFKNU5ZazhQSmhiUVU1bTdhWC9nSUR1T013RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQU1DZkxnZzQKRTF6bmN5OFBYcFZDNHNxK3BWNEFBY1pRRElncHZDbVBSajdxdkd5eUVaUEQ5bUVFa2toanNPMDNPamVhZlBUUwpnaUYwcEMvenFZZGNGZ2dZNFdrb1lxaTdNYWZCNEV2WWhTZlhIbndDcWc2eHZ6ZmdteWF1Nks0dm56RXlnVGtNCmJhV0hrRWMvRm5pc1Z5aUM2YzNFamgwTEoxV1N1WVFYRkpGOVo3OGFNU292R2RTRE5pcERGVDdEWFNGdjVjZFYKNTFTOUNBMDdHS29XTGVKenhiMllJcmEwd1IweEY2eE4ydDM2R3ljdUo5N3hpS3RIWlJGMnQ2ay8rVjZtTnB5aQo4WklSZnRwMjVwWHg4aldIR1lMQmNqVEtLVWJHRUxyejVrd1BiYndGS2JuM1ZHU01KMm1KaEZjd0xJR3dlVVpNCkhqZmFnazIxTkZ0SnUvTU03clZZYjJIVWdRdGpaTHFwMGdpV1VIcWYyMXlUQ3hKRzEvY3VMNHVYSlR6aWJuKzAKbFZYVUFMbittZFVaTmoyaVlnaEFSRzNTQStPTjRjL1VqVTFzREg5Zm1NWnJVYjVJL1hLaEFFb2VpcENvbXFYOAo3QTgxdytpK3JJY2ovNzZqWjdXei9BQU9PT2pjUzZVUnRRY0tSellIckRlZlVGdVJXUEVxWkRXTmxBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.a896778.kyma.ondemand.com"},"name":"garden-kyma--a896778-external"}],"contexts":[{"context":{"cluster":"garden-kyma--a896778-external","user":"garden-kyma--a896778-external"},"name":"garden-kyma--a896778-external"}],"current-context":"garden-kyma--a896778-external","kind":"Config","users":[{"name":"garden-kyma--a896778-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-7a69075f-7faf-4604-a62e-806648791dba\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./uk-south.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - xp264-001"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |+
          "apiVersion": "v1"
          "clusters":
          - "cluster":
              "certificate-authority-data": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRS1hqekxhWFBrK28rUHRoTjIwY0dpVEFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRFd01UY3dPRFExTVRWYUZ3MHpOVEV3TVRjd09EUTJNVFZhTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUF3aFgxCittR0wxUHBzMnhQTWdIbFBYY2dyRmtRNW1XU09VNlFId3FCeDBYN205am93MHpYa1dwTjd4TmhqTmdQMEFwNS8KcmpYcDB5Y1VicmExcmNRMXhHZWJaV0tRb000VjZYUWRTUzJWeldxUmFmV0w4bWpDNUcxcktyZ29obTZNYmNKQgpXYkxOM0RhRXkzMGZSdElzbVhGWjFuVytqeW1jTW1RcjZxeGxHMmttenM0M0pkL0hvdWtXb3dlY2p2QzViTWJ5CmlFeHdPSWdPdE94T2VNNVl2NFBhb2VPK2JqQ0dxM0Fic1laUVY2MS8wSXQ4N2ZPV0hjUzhBWmc3UDdNcnpmalIKTGJxZWlHLzEwNUVLcFRoTkJxbTJTZzRwdXFuY2NrbzV5Y3lxNW9uakhOT0RDZ1RDUDY4S09NYndOQ0phclNMRQoyOHg5RmE0cUFxdytuclZrRWlHSWFVbGlvalpweTVPd0g1aUhpcHJNd1JpTHFGT1JGN1YrNnpWaUZvUXN3T25qCnZoWGV2K3p2NU1YT3hoSlhjL1QrSFpPV3Y3WFE3QTFoR2E4ODNkK1lPRjdacE5tbm5sS3hRaGpnajBiRk41cXAKU3ozWGxSSnpZQnNodDhLMG9EQXc4bDcrbzhXWDU0S3NPMG45SmFQL3pzdFdUa1hWcUppcncza1Z1cm9QQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCU3ZiT0d1SWtkWVBPQ0JrZ0tMY21hWjBIWHJaVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBR2o1N0xLZisKbHFreW9VT3JhN2E4QVdacmdyVk5ETkZ4Wjlsb2NKWHZ3b01rbnMySGRYcjQ2TFIrNHova1RORUR5Q3h2NjF2YwpOdVA5eUFtclFBOWd3ZkVnQjVYQmdCZU9lTCs1NEFwYk1yZTFYWVJiZ2JuOEVxMXdnWEJJT1Q2TlJjWDYvenlECitOUkN6RkhjMFUxYVMvNGY0eGRxK3RFQmZHWnV1MGlyYnVrWmw2bEhGci9Vb0h6Zkh4Y0E3eWgxdlVzWjJadDMKOVhHaHVMM3hzQklnc0ZqcGE5TkM1dU02d0ExMWZpUWtlVmtHUWhDZEFRZlBHczBwRGJTQWduV0UwRUdSbTJyRQo0OEpDZTdhbGQyY1hmYU1ZTVdESmFQakxzUjUyRU5YeWZPc01SZlc0ZVRvZDZXNXhCYlJpSVRoTlR5SlFSU1g1CnlXVkxURnkrK0htS2tDRkthWFJNeGVTb3hVdDNhcnFCcE1OSlErc2RrUEx1Nk5VWlR5NWl5VEI4V1VWcGhHd2oKaFVGbldlcE9penoxbnczMTRCS25KVk1adXNrZVpITHFyMGdGWHBBVk1sdmZLWHJpUi9NakttRTZWaTZkNlErUApDVVZBSThSbDR0Sk5NYTB1dkFFZmpUdENVdjRObWRQRmEvRnduZXlnMzNsbkxLMlk1UnE2ZFJ2YgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
              "server": "https://api.c-13f520f.kyma.ondemand.com"
            "name": "garden-kyma--c-13f520f-external"
          "contexts":
          - "context":
              "cluster": "garden-kyma--c-13f520f-external"
              "user": "garden-kyma--c-13f520f-external"
            "name": "garden-kyma--c-13f520f-external"
          "current-context": "garden-kyma--c-13f520f-external"
          "kind": "Config"
          "users":
          - "name": "garden-kyma--c-13f520f-external"
            "user":
              "exec":
                "apiVersion": "client.authentication.k8s.io/v1"
                "args":
                - "-c"
                - |
                  set -e -o pipefail
                  OIDC_URL_WITH_AUDIENCE="$ACTIONS_ID_TOKEN_REQUEST_URL&audience=gh-teched-3b7520c4-24f3-455c-8fca-d1ef74d3c868"
                  IDTOKEN=$(curl -sS \
                    -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                    -H "Accept: application/json; api-version=2.0" \
                    "$OIDC_URL_WITH_AUDIENCE" | jq -r .value)
                  # Print decoded token information for debugging purposes
                  echo ::debug:: JWT content: "$(echo "$IDTOKEN" | jq -c -R 'split(".") | .[1] | @base64d | fromjson')" >&2
                  EXP_TS=$(echo $IDTOKEN | jq -R 'split(".") | .[1] | @base64d | fromjson | .exp')
                  EXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)
                  # return token back to the credential plugin
                  cat << EOF
                  {
                    "apiVersion": "client.authentication.k8s.io/v1",
                    "kind": "ExecCredential",
                    "status": {
                      "token": "$IDTOKEN",
                      "expirationTimestamp": "$EXP_DATE"
                    }
                  }
                  EOF
                "command": "bash"
                "interactiveMode": "Never"

        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./xp264-001.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - xp264-045"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |+
          "apiVersion": "v1"
          "clusters":
          - "cluster":
              "certificate-authority-data": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRYlRrbXdOZjZCdWVCbmsvNHIyUWdSVEFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRFd01qRXhNREEzTlRKYUZ3MHpOVEV3TWpFeE1EQTROVEphTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUErQ1k2Cks4M1A5dlkxdVNYSVp4dk40M29WNnlySzN0cnVhbVQxd1VtSUJLUHpzd2VndFZCZE5SbWRDSE5iWWtmZFFuMmcKbEdKU0JWNGx3a0dMcm04bkR6YjU2NlUxclRac1dWTzgyNTJNMEVXNW9QQTVVcTJOVTRZUnFEcks5QU5aN2xnbQplc1Vqb2NmZWtUMElWYlZJUWV3M2ZWQnZLN2tiWnN5cjlyVUZ3bVUreGJlc1VXZFNGNXFzWGdJZlcyUjVRb2RyCmFrVUkrSGpzMzZkTWZXY3p2ejhsZkxZR2ZTbjE4Z0NRNUYzMmZEK2psWmtFalNZV095aUJMS2dwOERac0JuQVcKMENuZjVoS2pvWDFwVXNqQU0wSWJ6SWpPWmdSOE15LzJJZG5QUUcvTGp0WlVCdGVBQy9LQnd3bU9DRDR1SVd4RQpxblRheU1LTmZvSGdpQm9qYVBSUnRqQ2o0U2ZqVHlSQkluL2lmYmVKeXZOZ2h3S0MrVzRIc2o1c0RvMG8rU25CClgzYy9pSFdWYWxkajNCajExSXRMV21RWm1PSXdJSktGK3VEWVpEaS9MNW1GOGhSVzZQRHRiR3ZodUtjOXJmZWgKdHJQb3pvVkk2enJRbVZUbUJaY0c4dG5HUnNnMmZPYmNiWnJNSlg3ZTVWTzh4VDc2RHp5M1lKU0NXMHVaQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCUXZpdytCZWIxVDBndE5tYlBzZyttMGhzQU9ZekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBaTFLa0JwK24KMFVSYkVlVzYvLy9ycFMra0d3clRJSk5vNDgzUm1ZSkFTV3NSOFVGZnJxVzZ5Z3VWcVB4alQzbkZ1MFNlUWRvdQoxT1F0RFIxTXFuNzRCOFJzcE1aU21hMkJOT1BjbEZRc3N4ai9kOWlLdzJDaldMZkJrbnFjdFBGOEwxRExHT2xPClBQaUNkNlI1SHZwb2c3clE2MFo3REJ0R08venRrM3YvMEtxUHlVRXJ2ZDVxUytsQWZ4eUM2ZGhEOFJlaWw5UTQKakFYQUpLaFhGc0lEZldvbHF1dk5FTnZaK1gvV0NTakRyNFhUZkd2TEQrYVExdVVlOExGZkgxVFM2cTg0Ly9xRQovWkxlWmoxNDVrYllDT2s4ZTRTQzJQdldxVXdYUm9TVUIzQWp4andxZS85RmFjTjhjYjY5djBoZWIwUkk3Qk9IClFJdlMxMTJqOSt4ODF4MFFENzZxK0loVHR3VWNnY1BuUWQzRUU5K1VUNml5Znd4cGNJL0xWMWh2S1cxQ0NGbzQKMmtTWWNNRng3WEdETmNYVG5McE9YUWR4d2dmcXZlZ1JCdkhFQm0xZVcyUUk5dExYQjA3MEc2ZkVTNkdXN3RtWQozdTdhb2NoRnp4dnQvZitrcjJVOHpoYzlpMUJrWW5RU0RyQ0ZRalN2dHFXdkZKT09IV3hWN0lsNQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
              "server": "https://api.b242c25.kyma.ondemand.com"
            "name": "garden-kyma--b242c25-external"
          "contexts":
          - "context":
              "cluster": "garden-kyma--b242c25-external"
              "user": "garden-kyma--b242c25-external"
            "name": "garden-kyma--b242c25-external"
          "current-context": "garden-kyma--b242c25-external"
          "kind": "Config"
          "users":
          - "name": "garden-kyma--b242c25-external"
            "user":
              "exec":
                "apiVersion": "client.authentication.k8s.io/v1"
                "args":
                - "-c"
                - |
                  set -e -o pipefail
                  OIDC_URL_WITH_AUDIENCE="$ACTIONS_ID_TOKEN_REQUEST_URL&audience=gh-teched-2ec5d15b-ab55-4352-ba58-e161ed0bc169"
                  IDTOKEN=$(curl -sS \
                    -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                    -H "Accept: application/json; api-version=2.0" \
                    "$OIDC_URL_WITH_AUDIENCE" | jq -r .value)
                  # Print decoded token information for debugging purposes
                  echo ::debug:: JWT content: "$(echo "$IDTOKEN" | jq -c -R 'split(".") | .[1] | @base64d | fromjson')" >&2
                  EXP_TS=$(echo $IDTOKEN | jq -R 'split(".") | .[1] | @base64d | fromjson | .exp')
                  EXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)
                  # return token back to the credential plugin
                  cat << EOF
                  {
                    "apiVersion": "client.authentication.k8s.io/v1",
                    "kind": "ExecCredential",
                    "status": {
                      "token": "$IDTOKEN",
                      "expirationTimestamp": "$EXP_DATE"
                    }
                  }
                  EOF
                "command": "bash"
                "interactiveMode": "Never"

        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./xp264-045.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - xp264-050"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |+
          "apiVersion": "v1"
          "clusters":
          - "cluster":
              "certificate-authority-data": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQU01WE0vSkE4bXdxY1BiUlJyc3Foamt3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVeE1ERTFNVFEwTlRVd1doY05NelV4TURFMU1UUTBOalV3V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBS3FhCmtXc0JGSE5JbmhMa0k5MUtMOXFWS0h6OEZiVmlUVTJiMktyMnF2UXpkOHlNSENKekczaWRFOS9ac3RNZWpOaDAKdmFPN1NTNmptTkJRYis1ZFFrcVgxMW1CSDJRZzRTSXpEMUttWWRxSStZeGJRdjdVNFJVdGdmdTR0a1ZCdTFUZgpjQnM0VkFOTjFENkJxT2t6VFppVmlrNFVHNlNxSUJNZWJxR05GOHdrdWpsbWpmV05jZGEyN3R5cnorK0ttWFVrClN5bkpXOWI5cnpCVENCK3Nhd3JpVVIwSlVsR3ZrOTFlQ0dSelBJV1FrUUQyYy9JcFlBRE0rcGt3dnBiNHpXK1MKdFY3d0cwbzFXK2crRXBiMFoxcHZyQ05CZDNOSVBkU0VnWXl3UE1SQlJxWUdWS29nZ2l0bnRCcGR3QkoxLzBxTAowa2JqbGRYYysvOFd4K3pwMnkxeDZ6STFURFdoUGRXQlI2TVRKYTBmTWdZQXl3VWhadTZrcFRVQ0dXb3JyMXJwCkJtSURTeWNGRVhPaWowOExVM21jYUQ3MFZob3pidmo5bFJxU0owdlNsNVh5THFiTC9UTWk0UmxzSktDV1M0cU8KNmtpWkhhaFBXZE5FZWc5cjA0Skx6SmV5RXRqTGEvS0d4OVBielplcjZsdmUvM1VRSXJ0R3o5Q3NnYWdrdHdJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVUzZzlnUUh4aWZsbFpCRU0vZ1BHVjg2SFhFRGd3RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQUJTUWh3YmgKNUVYeFhXVmd6dEJmWEpCSlBSL0xKTkQxVzFZZFJMN2RabHZDTlR4WDZKTUV6aDhtakdxL1A5RDVJc056eXpIdQpYSzh5RzRyZzBSRWFwRUFvTi9hQllSUkhzelYwejNtNFhqdEdTOUp0MW1ML2JKanpNMEFnUjVtb3lpMFQwcmpWCnN6RWYvK09OR0dvaEVvMlh1VW1zT2FMcFMxL0hWcWUxcWo4RU9JaTJCZFExMnZINnJ1bXBkMWlWWms4alorOTkKYXVZakhEVmcycmdwcUdOL05ib05PN1RKWmwzUDdyQ29rRy9Va1JRQU5lU1BPOEl6U0oyRjhnOXV2VUR4Z3dTOApOTmp3MmhhVXg5Z0JGOVJhYkd0cEhzcTBCYnZhT3QwZGNleXA3UW92Sk45QkVPZjU0dUwxMG1POUluWW9tTFRhCkw3cDJSdTVuYmlkcXppODRZOXVFd2YxYmk1Y05LVE1GRVh1NURvVjZKZWlIenp1YWt5b2dORzBxbHg5QitCYVIKb1huelFSeEkwNCtVNVdQZVpNdlFxMFdBZXpna2tpZkZTWVhOYkE5YWZNeHgzSFk1ZkJpV1FxaTUxbjQ1a2tlZwpoTXNONFMvd2pXbkxlMjlQVU1TOHIzeFpneVlxZitMbkxzY0VUZGtrQUorKytjQWhYR2dPS2VjVmRnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
              "server": "https://api.b07e82e.kyma.ondemand.com"
            "name": "garden-kyma--b07e82e-external"
          "contexts":
          - "context":
              "cluster": "garden-kyma--b07e82e-external"
              "user": "garden-kyma--b07e82e-external"
            "name": "garden-kyma--b07e82e-external"
          "current-context": "garden-kyma--b07e82e-external"
          "kind": "Config"
          "users":
          - "name": "garden-kyma--b07e82e-external"
            "user":
              "exec":
                "apiVersion": "client.authentication.k8s.io/v1"
                "args":
                - "-c"
                - |
                  set -e -o pipefail
                  OIDC_URL_WITH_AUDIENCE="$ACTIONS_ID_TOKEN_REQUEST_URL&audience=gh-teched-67debbc5-8d77-41ca-acba-7443e0a413ba"
                  IDTOKEN=$(curl -sS \
                    -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                    -H "Accept: application/json; api-version=2.0" \
                    "$OIDC_URL_WITH_AUDIENCE" | jq -r .value)
                  # Print decoded token information for debugging purposes
                  echo ::debug:: JWT content: "$(echo "$IDTOKEN" | jq -c -R 'split(".") | .[1] | @base64d | fromjson')" >&2
                  EXP_TS=$(echo $IDTOKEN | jq -R 'split(".") | .[1] | @base64d | fromjson | .exp')
                  EXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)
                  # return token back to the credential plugin
                  cat << EOF
                  {
                    "apiVersion": "client.authentication.k8s.io/v1",
                    "kind": "ExecCredential",
                    "status": {
                      "token": "$IDTOKEN",
                      "expirationTimestamp": "$EXP_DATE"
                    }
                  }
                  EOF
                "command": "bash"
                "interactiveMode": "Never"

        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./xp264-050.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - uk-xp264"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRQnBmaHN3SmppckNMRlNoQ05UM0h5ekFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRFd01ESXdOalF6TUROYUZ3MHpOVEV3TURJd05qUTBNRE5hTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUF1N2d3ClBMbmFSY2k4bVZXWWdSYmNveHBNN1FybTVPQ0pUYy9xYVRNaHRqVUt2TDYyYnFPWmFBQURNaDMxVjlTbmc2S1UKUkFwdzR5ODlselNsdUh1SGZySEVmVGtXT3E4dDBqb2M1eW4raFVEeTZTbE9ZVlJ5RmY5UlZMOHV2MnRFOURkZQpHUk9CTFdXRXIwbkM2VzYwYTdUUENFeVJvQzIyU3M2cDNzZVBDaVJlVWdENk11ck8yeWxPQzFGSU9JdFZ4anlkCkFWb3hJaXlwa3l0RGw0MkRINkQwczgydW91VzZ2SVpkbWxZcW44YlMrbUZ2QkYvMGlIZC92UEdaMmo5MTcrc2QKQ1BrckF5enkxd1Y0TTRtZ1JJZ3ZMVG1PRDZyemRvOHJWRkFhUktRd3luMGplcjhhUnVzekFJejFxUDNzSlkxSAo0SlpmRzBxQUFHM2V0RkExc2Z1eWk5ZEpSZFNvZ0V6QnQzYUFWRUZKcEJlWHlncTB1K1phVkY2dWQvaDFYMmlVCjhFV1BxVDN5aHgveFZOaVpQaGRpczQyMXZPRDU0Q1RSS0JsMEVwODh6UXJkV3hGR0oxODRzcE0rZkkyc0twWTMKbURNZXkyd0ZadXR5UU10M0VqSlRsWkFWRVVPc1JIcnZZV0N0ZzF5OURITXRmb29xeXpZZ0R5UWdHTTdoQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCU0RtSHkxWkM2TjhjUWp4SjdDY2djcGxqbkZoakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBSnkxYzBHZGcKVC9WTTBicExSbzUxYnVZUHZqMGFlenpKYWUweS9lMy8vVUptTmNBOCtIb2xhaFZhOXUxVE5GYzAxK1UwR1dLNQpJVUZFNWExdjVCdWlMOGJBRzhyV0JkeVJ3QkJJelRQVTdvRm9EblZuU1FOTXVYSVNUdTE0QS84NzVkK1crM0FYCnhLand6U0RHc0U0Wmp4Zy9vVnJDNDJZU3pFcW5ISkNpTGNsVWFzM1lzNWVTWjFQNEhvcTRhcjE0U05pK20xejkKVzNLb3R3Ly9PUU95dFJGcVhBc2ZrTkVMQ25rV2RONG1FWEdOVVJpZjdDTjJ4L05LQm9yU0dWa0ZtNjd1WWJqSgoxcDhHZTIwK3ZJZEdvR1d3Q2lLendLM0hiUHpVbS9FbDZLZVVzMVdIL0o1TFRZelNJU3Q1eldyZkl6amtSY1E2CkQ1OTdWN2NBQVlDL3dWWC9wdkdWeG1DR3J1aVY5QTRjTzhYNlVFaVZaUE1ubW5wUE9XVW1KV29PSklqYkFJakIKWGNkaWpHU1RtYzBDUmxIYjUxSGdYUkhNRCs0RXhyQzV0VFQ1NVF4R1l2SHZ4SzFCUDFsbDVhU1JHdHMyd1FoMAprbzN3eW4wUSt2OUhWMzRmVXZTc1doZ0NRdTdmcHl3WUVLQzBUNWdVYlNCQWRPeTA0TDkyemY3VwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==","server":"https://api.b84edf3.kyma.ondemand.com"},"name":"garden-kyma--b84edf3-external"}],"contexts":[{"context":{"cluster":"garden-kyma--b84edf3-external","user":"garden-kyma--b84edf3-external"},"name":"garden-kyma--b84edf3-external"}],"current-context":"garden-kyma--b84edf3-external","kind":"Config","users":[{"name":"garden-kyma--b84edf3-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-76f46b5b-d9ab-486f-8e4f-12e1163af943\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"

    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./uk-xp264.yaml

        kubectl version
        kubectl config view
        kubectl config get-clusters

        export TOTO=$KUBECONFIG

        # https://able8.medium.com/how-to-merge-multiple-kubeconfig-files-into-one-36fc987c2e2f
        #
        export KUBECONFIG=:./uk-xp264.yaml:./xp264-000.yaml:./japanese-east.yaml:./us-east.yaml:./uk-south.yaml:./xp264-001.yaml:./xp264-045.yaml:./xp264-050.yaml
        kubectl config view --flatten > all-in-one-kubeconfig.yaml
        export KUBECONFIG=$TOTO

        cp ./all-in-one-kubeconfig.yaml $KUBECONFIG
        #cat $KUBECONFIG

        kubectl config get-clusters
        kubectl config get-contexts

        kubectl config use-context $CLUSTER_CONTEXT
        kubectl config current-context
        kubectl config get-contexts

    - "name": "check namespaced permissions and resources"
      "run": |
        echo -e "checking namespaced permissions: $NAMESPACE..."
        kubectl auth can-i --list --namespace $NAMESPACE
        kubectl auth can-i get gateways --namespace $NAMESPACE
        kubectl auth can-i create apirules --namespace $NAMESPACE
        echo "can access kyma-system gateway?"
        kubectl auth can-i get gateways -n kyma-system
        echo "can access all other gateways in the cluster?"
        kubectl auth can-i get gateways -A
        echo "display all gateways in the cluster"
        kubectl get gateways -A
        echo -e "display all pods and secrets in the namespace: $NAMESPACE..."
        kubectl get pod -n $NAMESPACE
        kubectl get secrets -n $NAMESPACE


    - "name": "install kyma cli"
      uses: kyma-project/setup-kyma-cli@v1
      with:
        version: latest
    - "name": "Fire-fighter access"
      "run": |
        kyma -h
        kyma alpha -h
        kyma alpha kubeconfig generate --help


        echo -e "*********** Namespaced access with a new ServiceAccount ********************\n"
        echo -e "\nPermanent and namespaced full admin access\n"
        kyma alpha kubeconfig generate --serviceaccount kyma-cli-sa-permanent --clusterrole cluster-admin --namespace $NAMESPACE --permanent
        echo -e "\nTime-boxed and namespaced full admin access\n"
        kyma alpha kubeconfig generate --serviceaccount kyma-cli-sa-time-boxed --clusterrole cluster-admin --namespace $NAMESPACE --time 1h  

        echo -e "\n*********** Namespaced access with an existing ServiceAccount ********************\n"

        echo -e "\nPermanent and namespaced full admin access\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa --clusterrole cluster-admin --namespace $NAMESPACE --permanent
        echo -e "\nTime-boxed and namespaced full admin access\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa --clusterrole cluster-admin --namespace $NAMESPACE --time 1h  

        echo -e "*********** Time-boxed, cluster-wide access ********************\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa --clusterrole cluster-admin --namespace $NAMESPACE --cluster-wide --time 1h > $NAMESPACE-sa.yaml


        echo -e "\nList of pods with: $NAMESPACE-sa.yaml\n"
        kubectl get pods -n $NAMESPACE --kubeconfig ./$NAMESPACE-sa.yaml


        echo "kubeconfig as string"
        timeboxed_kubeconfig=$(cat ./$NAMESPACE-sa.yaml)
        echo 'timeboxed_kubeconfig<<EOF' >> $GITHUB_OUTPUT
        echo "$timeboxed_kubeconfig" >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

    - "name": "Fire-fighter Read-only access"
      "run": |
        echo -e "*********** Namespaced read-only access ********************\n"
        echo -e "\nPermanent and namespaced read-only access\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa-view --clusterrole view --namespace $NAMESPACE --permanent
        echo -e "\nTime-boxed and namespaced read-only access\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa-view-time --clusterrole view --namespace $NAMESPACE --time 1h  

        echo -e "*********** Time-boxed, cluster-wide read-only access ********************\n"
        kyma alpha kubeconfig generate --serviceaccount $NAMESPACE-sa-view-all --clusterrole view --namespace $NAMESPACE --cluster-wide --time 1h > $NAMESPACE-sa-view-all.yaml


        echo -e "\nList of pods with: $NAMESPACE-sa-view-all.yaml\n"
        #cat ./$NAMESPACE-sa-view-all.yaml
        kubectl get pods -n $NAMESPACE --kubeconfig ./$NAMESPACE-sa-view-all.yaml

    - name: Upload kubeconfigs to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: timeboxed_kubeconfigs
        path: ./${{ inputs.NAMESPACE }}-sa*.yaml


    - "name": "btp runtime context access."
      id: cluster_info
      "run": |
        echo "btp runtime context access...."

        kyma alpha diagnose -f json | jq -r '.metadata'
        #kyma alpha diagnose -f json | jq -r '.nodes'

        DEEPLINK=$(kyma alpha diagnose -f json | jq -r '.metadata | { deeplink: ("https://emea.cockpit.btp.cloud.sap/cockpit?idp=${{ env.IDP }}#/globalaccount/" + .globalAccountID + "/subaccount/" + .subaccountID) } | .deeplink' )
        echo $DEEPLINK

        GLOBALACCOUNT=$(kyma alpha diagnose -f json | jq -r '.metadata.globalAccountID ' ) 
        echo $GLOBALACCOUNT

        echo "GLOBALACCOUNT=$GLOBALACCOUNT" >> $GITHUB_OUTPUT


"name": "_k8s-fire-fighter-student"
"on":
  "workflow_call":
    "inputs":
      "IDP":
        "description": "platform idp"
        "required": true
        "type": "string"
      "CLUSTER_CONTEXT":
        "description": "cluster context"
        "required": true
        "type": "string"
      "NAMESPACE":
        "description": "students namespace"
        "required": true
        "type": "string"
"permissions":
  "contents": "read"
  "id-token": "write"
