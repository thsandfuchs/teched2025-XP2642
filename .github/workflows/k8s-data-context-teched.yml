on:
  workflow_dispatch:
    inputs:
      ACTION:
        description: "setup/destroy k8s data context"
        required: true
        default: "apply"
        type: "choice"
        options:
          - "apply"
          - "destroy"
      IDP:
        description: "platform idp"
        required: true
        default: "anuk8cmfw.accounts.ondemand.com"
        type: "choice"
        options:
          - "anuk8cmfw.accounts.ondemand.com"

      subaccount_name:
        description: "k8s region (subaccount) name prefix"
        required: true
        default: "xp264-000"
        type: "choice"
        options:
          - "xp264-000"
          - "uk-south"
          - "japanese-east"
          - "us-east"
          - "uk-xp264"

## Add shared Environment Variables across jobs here ##
env:
  RUNTIME_ACTION: ${{ inputs.ACTION == 'deploy' && 'apply' || inputs.ACTION }}

  CONFIG_DIRECTORY: "./exercises/ex1/k8s-data/"
  PATH_TO_TFSCRIPT: "./exercises/ex1/k8s-data/"  

  CLUSTER_CONTEXT: |
      "${{ inputs.subaccount_name == 'uk-xp264' && 'garden-kyma--b84edf3-external'
      || inputs.subaccount_name == 'uk-south' && 'garden-kyma--a896778-external' 
      || inputs.subaccount_name == 'xp264-000' && 'garden-kyma--c-4d2de7e-external'
      || inputs.subaccount_name == 'japanese-east' && 'garden-kyma--c-99567a9-external'
      || inputs.subaccount_name == 'us-east' && 'garden-kyma--ca15e0c-external'
      }}"

  ## Additional env variables
  ## https://developer.hashicorp.com/terraform/cli/config/environment-variables
  # TF_LOG: DEBUG ## Helpful for troubleshooting
  # TF_MAX_TIMEOUT: "30m" ## If you wish to override the default "1h" 

"jobs":
  "apply-manifest":
#    strategy:
#      matrix:
#        cluster_config: >

    "runs-on":
    - "ubuntu-latest"
    "steps":
    - "name": "Check out Git repository"
      "uses": "actions/checkout@v4"

    - "name": "Install Helm"
      "uses": "azure/setup-helm@v4"
    - "name": "Setup Kube Context - xp264-000"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQUpjRnZWQ1hnbXljc3pDSHMwVVRzZ1V3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVeE1EQTFNakF6T1RVMldoY05NelV4TURBMU1qQTBNRFUyV2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTEZ2CnY1S0dSNXJBakRmS1BlMGVVaG13K2hjNjFQb09xb0tocWJNNEYzZWpia29CU3pZL09BaHR1ZEdWUysreFhvTW4KUk5VYUNMV0VMbVhjN0x3UUZiYjBQTzIySlo4emRVNGJ5U0tZUWxvSVRodERHTGY1T1d1Uit4WXRaRzdWaTVhZApvSHN2ZisxRTRCdnA5SmhISmdySm1KdlVBRW84K1dwU2VwNHlJWTZLRFJMczR0V0w2bFlaTkw2RnFjNWJRYnMwCjFtRFNXcDJkRjV1c2k5SHJUcXRQMS9JU1JmSVN3dlRBYnh4OWVXU3BvYklmejJwQncvdnRIcEdQSTV2ZnVaMUQKeTdoTVdkNnFLVWQrZmRVWXV4L1dQMS91YStvY1VqUXZYeFIyeERlSjF3TlVCczViV043citHT1BpNGFvVmh0cQpmOEc2MFdsZ2lUM1gyZ2ZCN3BkbWFQZHl5N3NFZkcwTmdsejdBYXlwZG4vV2VxZitIcFUrRmFSZjZPdXlmSENXCkMyNWluM0hDeko3Wmp3Y0dsVVpwOGQ1VHVITVVNT28yQndoRG5sWGRsVnZTamN4Mk9tTVZoUW5xM2xhWXdtZXEKVURXcldON3dqUE5hUXl5NVBmQUJ2ZGorKzBVVUpndWt3dDRaNENpaVR6aG8wS3hpTytrN0xycC9iSSszUFFJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVwMWxMbDBRY1U4aGJoeGZCVEd3Ylo4YXV2Y3N3RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQUVlOG5MN3AKRGhiSUJVN3Y1ZWRTTVcvV3NDL3pOaFA0SC83LytVc2t2c1BEYWJDZjJpNW9SWW5uOU95NkRQcjhqc0wrVTJ0bQovRGpKcVROZWxrRi9BV0NISk93Zk8yVUgwRm1zejJZc3ZJeTA0Q05DSnUwTHlWRFRYYlI4Mm1WZjI5MDZJR0UwCmVlS1JuZVhQOWpmZ1NhWklVMjhvK0RmTHJ1V3JEME9tbHQ2U1ZMSHdxU3VjR2xBN1FJWjI2eFJWS1RZM2tkZXAKVnpheVRLTFpiZzZQVjFJUUwzUjlrWjNNQWRwL0l6L05YMlZJSStYZnU4clh3ZXJGS3VuN3ZIT3g1NU9abWxPVwpxcWhQMHFzdGhwQUNjSXpsWEx1RFFFUEtlVGNick1WQk9CSEhheVhGNTl5V3NjbStJL1o4OHNpc3dYdXF6VmdVCk1XaEhDQUM2TFk3UkkyQWt3a1RobFMvRy81UnpOTFI5UkFmMitwRGhpeXNwT2JhbzRTVGxuRmhPL3hPMXBPSTgKUFo2VGRiY2tIMmk2cmJYTXVkTmkrdmtac2lWaHFhTFpNZ3NvVmlaaTZlTzNSRENuOUVLaTBBUmlSdnUzRlExZQp6RmdhazNwY3kwZitDSU5aNitZVmZxdHM3eUZ4NkVQaXQyVTZGbC9QbWlCNUc5SVgvdUNMZVFMNStnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.c-4d2de7e.kyma.ondemand.com"},"name":"garden-kyma--c-4d2de7e-external"}],"contexts":[{"context":{"cluster":"garden-kyma--c-4d2de7e-external","user":"garden-kyma--c-4d2de7e-external"},"name":"garden-kyma--c-4d2de7e-external"}],"current-context":"garden-kyma--c-4d2de7e-external","kind":"Config","users":[{"name":"garden-kyma--c-4d2de7e-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-622af3fe-a2f5-4fdd-a05f-73e343aec2a5\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./xp264-000.yaml
        cat ./xp264-000.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - japanese-east"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQU9DemdDNWw0TmRHNUhxSi9ieTJnRGd3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVd09USXpNakV3TmpNd1doY05NelV3T1RJek1qRXdOek13V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTGl2Cmp2Mkt3RklIckRGbC9pQlBFOGVxUDVsZ2dEdHJ3bUtHUFQyTVNEaTBDWnhjUVFwbVpseUs1ZlREQzVrUmdQYVMKUmZJN2hSMVNCVW5BMmN6ZUxJU0NlTTAwMnI3ZVJyZ0FIUUlYWi85SkR2aDM2OFhJSDdXazdVY1F6TU9DbW13ZwpmNDBLYVNRUGVSN1hmNnhlTGc5SFVGQnNNZ1dDcE1EYmZ2dnE1d2VDdVRnS0d2eTZlVlVQaXBoTGIyMTFpbURFCk5xS1N2RW1JeThPUTdBUWozVzdsNVJvbTFSSVBQUWVHaXBnQ3NaVE1oT2JnYStPYVNzS1pFZlBWQnltWjI1UE0KOW5Nd0RnT25mSzJnMlA3bzQvdEFRdjg3MWU0am5nTUdPVjhncmVoVGdCN3VnVzFsdkRXNTBOU3RDQmxLMjlRTwpwVHdCbXh3R1lMU1VyU0hBWFhoUUNUS1IrcmV3VEJSM3hIMk5uaGl4dFNXdkFOUXAzZDNocjVnSE1ZQVN5M3VvCjRYdFZTRStvTnlyRVV1RGhicVJmK3hyRzlSdndidHNWZkNrMlNKYTEwdGN1R1VaQ1BJc2VXTG9nYzRXRHE3M3cKRDhENUQ3Y1BoYjBrZ1UzbmhWTHphaGhCelUwOWM1LzVnRUNYVC9pQk0wcmZBRytTNUkyQ1g0ZkRvTHFaVHdJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVrQ1VaZjE1RFY4ZkNmUDFMNVhBWXFEa29JY013RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQURxNnRrcm0KblhJU1lvbVhwR1lSRFBrS2x4RVptVVRPQnpCL1lFNXVxMkdVclNwVDdKRkFuZmkrKzhmZDRCaGZPM2pMdmsyZApmL1ExL0dKT1g2aVVTMGJIUnlrNFo0SHZUN1l0bkJ6NkVlWFBBWGMyMmZpUjY3b0ZsdXFoUmRsOXhGdUFaWTlJCnFCem1ZNmVOdXJKcStBL3VLZG1xakFXNTRhTXhZWGtERWFFaEszYVV4Ukx1RkMrdjFEQ2RCbWdGNnJTUnQxZHMKTUtJM1ZzTFRxTG1hU0ZQdURad3lYTDNsY0xtL2F5UWFMNlQ5V25QT1o4MWJBejdwMVBRU004RVZYS1o1UjV2RQpKWUFGWUw4MWN3ZEEwWW4wak5JdHA4ZDNpMm9wenMzMkk2K2F4Sjh0Q1I5amZhTXh2M3p6Z0RxZTJvQ0NQTGZ4Cm04dks3TFFGbXI4SU1GL0kycDhTYVNCeVlpYkI0OVNaQ1hvU3hJYTZqaEFTaEFUZzkvSENReXZ5WkhGUEtwbjEKdVorQzMrVWd3YkhkbXJBYjRQaGNJSHJuclE3T3VJMlc0VUt5TEZvTzNTL3k1eVU5RE9XZmZ6dU1KMXRmaDNjWQplTmNZa1B4R0svUnFpN0h4VUtwWFM5emJIM2pqeWg4aTltRE9xZ1NmTFdKcldUZVBYMndUT3l1UHNRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.c-99567a9.kyma.ondemand.com"},"name":"garden-kyma--c-99567a9-external"}],"contexts":[{"context":{"cluster":"garden-kyma--c-99567a9-external","user":"garden-kyma--c-99567a9-external"},"name":"garden-kyma--c-99567a9-external"}],"current-context":"garden-kyma--c-99567a9-external","kind":"Config","users":[{"name":"garden-kyma--c-99567a9-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-2a6fe480-ac84-4751-ad37-56ec2a493932\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./japanese-east.yaml
        cat ./japanese-east.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - us-east"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRTDkzRW45WGtQd2d0YW1jYmsrK3VmVEFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRBNE1UVXhNakl3TkRkYUZ3MHpOVEE0TVRVeE1qSXhORGRhTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUFwWEg4ClJSQlFsSUVmbGpWWVRUemdoZ0Z5UURwTjlUTnpOL2RGeGxDWk1VUWthS1FTZFByWEtGTXR2QlRRa0lnb0VvOVYKdXBZNU9WTkNDT0h1T3UvMWZwRkVwS1ZHQUJ6c3ZsSFVpQjhUZ09hcVR4OXQ4UkxTRkRxaGF3anZBWVBTQ1U4ZgpoN3NpOEUyVzBqT0E0MVhJUG9zWXN4K1BSekFVQnNSZURQT2huU3R6amdXWVhJbDc3WTZMNk1mNk0vSlpNeFFnCkdlZDFhMGtJWDI5d3J0cWJ6bnB0WmZPSHhkN0tmT0xCM0JLZzNUckVsME52QjNOMFVLV1ZpaUwwSjZrcmpsRmIKbEh3RUJxejJ0UlFJR08remZhdE9KdXJmcklST04wR21LYWttVEFzalNqei9KMW9SeVJzTHZoT0w5c3VTT0UrSApMcDNmZXdWNmkrZGgvT0Erc2tMMXRBWWdFWTVwbGV4cXVXVklvbGV2OURsSDBsTWxpMUpEY3hyUUtTclZrRy9hClY3bThWTjg4SWNBWmMrVTQwMmZKYytDUlFvQzh0c1VjWnY2TDk1K2pvL0VLQTQ3ZVJXdEp5czdkaGlNd2QzMmoKalZsaEw0anFVdDVCQnlPbUEvbnc2Vk9qdnU2R0lUNzlsTjBBZzB4dDJKdmpQWDJpL0Z2U2NyNHgrMG1IQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCUkxtNTVDK1VvVG9sSit1UGFLdWxMTjVsT3VzekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBVjNtVXhVTkQKRDhkdHV3Mmk5UnFLMWRnZUVPK1JzRmdONnp5OWV4QjU3aHRDT0tMVXJZaHBXcVFsWUIzbktaZWJCMEo4b21hdwoyS0E1dGdrUUJNdW1zYkQwVEl3bUNpakNxU0J4TDJBZ2tKbXhnVExWbmdmeW14NURFdVIvaWw2SlJBUC9HZ2NvCndpSnlwSGtHRVFOdTZmRW1CbEZnVlQ3aFdENTVSSFdwSWJTOFhYd1JGTWlDa3E0NU1heVhGeGFBOUdVNFNhcmwKeDhsRXlTem1Ja0RTcm90V0pXM2lwVVZqM0IyR3BxandtdlFuL2Z4V2dadUdvVVd2NEp3Z2FYd2UzL3hOangvNQozMVlqTmZ1NllnejBHeUw4NEgwRlo4Ym5KWmszekNLcGd3L1JwZ2UxSFg1MVE5bnVkMW5SS1hwOThYZ0VnY1ExClJIeG5LU2ZqQUtPbVhmeFltQ1d0aHR6T1dZbldyTWllWWNqbFg1b2VML1h6NW80R2FPRWowUHJ6MWxFcFZvaGIKclU0bkRwV01xQ0xicTlYL3NJTFlGY2o4alduVUYxTUFmbWg4aUJJMEZqbnk3bGU3bkpRazJEd2c1MEY4eDNYUgpROGdKcE9od3NRSUJEOWtwWnNTN1liZU1LeEpHaWtLcGhMd0xQSUlTNmJzQ1BlejRTajFjcjk0cQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==","server":"https://api.ca15e0c.kyma.ondemand.com"},"name":"garden-kyma--ca15e0c-external"}],"contexts":[{"context":{"cluster":"garden-kyma--ca15e0c-external","user":"garden-kyma--ca15e0c-external"},"name":"garden-kyma--ca15e0c-external"}],"current-context":"garden-kyma--ca15e0c-external","kind":"Config","users":[{"name":"garden-kyma--ca15e0c-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-dbe7346b-88da-430a-8777-4f6aa3e22b5e\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./us-east.yaml
        cat ./us-east.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - uk-south"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1ekNDQWsrZ0F3SUJBZ0lSQUt3bWpnd1VwQTQ5Rkw2Mkp3Zm56Y2d3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpVd09USXpNVE15TlRReldoY05NelV3T1RJek1UTXlOalF6V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FhSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTVliCk5pMmg2WVpUZjZyWlB3a0FIbmFLR1RReVU4Uk40NzFxOVhnTzFLcHM5K2pWVGRoTVVsTzd5U2hGRGM3dExIYkUKL2NPa3hYdTZYSFRSamR6SkttVUhVZDNwM2Y1K2NoMGw2b0p4YnRiZFByT1A1VSt6endTM2g4U1lVbU9vM0g1NwplQlk2TUIxVlRWSUxGSzM3KzE5V3dlbDZ4cTJ1TWdBTWVnYWhKaUNXVWtIdmJJRWtvN255SGUvLzIwUW4zVExuCmhtSExBZVNBQXEwbWZ6YlVkV1I3NU9xVzZNNUk1bHI2NHRxdzZDVmlvUGtiRGpBTUlDcWpMMlIrclVaMXNWQlQKMmhQT3FsSWRtV0l0U2hoUjIrVmtmR2s0T2FjeDFhWlYxeWNveTJIYngzY1BMaXNsWDFZMXprMGNBTThuc1cyego5cTBZNmZqeVpXd3FrMklrK0srSVNlSitNbDBSNTdQNXdQZmlFNlZkRjk5YWJtRFUzZjZyYUlSaDZidVRuSFlPClVKZHZHdUs3dTd0ZFRPQXQxVUV1UjBmRmdSZjRIZ296ejY4OXltWUN1Z0FtY095b1dkQnR0eTBieWt6QXdKUWIKQUtKcE5NVXhRYURpQkhkK1piSzJPbHhBdCttTzNxZkJMaWttRDZxNnJrTXNXUEF5WWlVSSt1TW9PRE1KUVFJRApBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVVPRmFKNU5ZazhQSmhiUVU1bTdhWC9nSUR1T013RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQU1DZkxnZzQKRTF6bmN5OFBYcFZDNHNxK3BWNEFBY1pRRElncHZDbVBSajdxdkd5eUVaUEQ5bUVFa2toanNPMDNPamVhZlBUUwpnaUYwcEMvenFZZGNGZ2dZNFdrb1lxaTdNYWZCNEV2WWhTZlhIbndDcWc2eHZ6ZmdteWF1Nks0dm56RXlnVGtNCmJhV0hrRWMvRm5pc1Z5aUM2YzNFamgwTEoxV1N1WVFYRkpGOVo3OGFNU292R2RTRE5pcERGVDdEWFNGdjVjZFYKNTFTOUNBMDdHS29XTGVKenhiMllJcmEwd1IweEY2eE4ydDM2R3ljdUo5N3hpS3RIWlJGMnQ2ay8rVjZtTnB5aQo4WklSZnRwMjVwWHg4aldIR1lMQmNqVEtLVWJHRUxyejVrd1BiYndGS2JuM1ZHU01KMm1KaEZjd0xJR3dlVVpNCkhqZmFnazIxTkZ0SnUvTU03clZZYjJIVWdRdGpaTHFwMGdpV1VIcWYyMXlUQ3hKRzEvY3VMNHVYSlR6aWJuKzAKbFZYVUFMbittZFVaTmoyaVlnaEFSRzNTQStPTjRjL1VqVTFzREg5Zm1NWnJVYjVJL1hLaEFFb2VpcENvbXFYOAo3QTgxdytpK3JJY2ovNzZqWjdXei9BQU9PT2pjUzZVUnRRY0tSellIckRlZlVGdVJXUEVxWkRXTmxBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=","server":"https://api.a896778.kyma.ondemand.com"},"name":"garden-kyma--a896778-external"}],"contexts":[{"context":{"cluster":"garden-kyma--a896778-external","user":"garden-kyma--a896778-external"},"name":"garden-kyma--a896778-external"}],"current-context":"garden-kyma--a896778-external","kind":"Config","users":[{"name":"garden-kyma--a896778-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-7a69075f-7faf-4604-a62e-806648791dba\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"
    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./uk-south.yaml
        cat ./uk-south.yaml
        kubectl version
        kubectl config get-clusters

    - "name": "Setup Kube Context - uk-xp264"
      "uses": "azure/k8s-set-context@v4"
      "with":
        "kubeconfig": |
          {"apiVersion":"v1","clusters":[{"cluster":{"certificate-authority-data":"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ1akNDQWs2Z0F3SUJBZ0lRQnBmaHN3SmppckNMRlNoQ05UM0h5ekFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWVGdzB5TlRFd01ESXdOalF6TUROYUZ3MHpOVEV3TURJd05qUTBNRE5hTUEweApDekFKQmdOVkJBTVRBbU5oTUlJQm9qQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUF1N2d3ClBMbmFSY2k4bVZXWWdSYmNveHBNN1FybTVPQ0pUYy9xYVRNaHRqVUt2TDYyYnFPWmFBQURNaDMxVjlTbmc2S1UKUkFwdzR5ODlselNsdUh1SGZySEVmVGtXT3E4dDBqb2M1eW4raFVEeTZTbE9ZVlJ5RmY5UlZMOHV2MnRFOURkZQpHUk9CTFdXRXIwbkM2VzYwYTdUUENFeVJvQzIyU3M2cDNzZVBDaVJlVWdENk11ck8yeWxPQzFGSU9JdFZ4anlkCkFWb3hJaXlwa3l0RGw0MkRINkQwczgydW91VzZ2SVpkbWxZcW44YlMrbUZ2QkYvMGlIZC92UEdaMmo5MTcrc2QKQ1BrckF5enkxd1Y0TTRtZ1JJZ3ZMVG1PRDZyemRvOHJWRkFhUktRd3luMGplcjhhUnVzekFJejFxUDNzSlkxSAo0SlpmRzBxQUFHM2V0RkExc2Z1eWk5ZEpSZFNvZ0V6QnQzYUFWRUZKcEJlWHlncTB1K1phVkY2dWQvaDFYMmlVCjhFV1BxVDN5aHgveFZOaVpQaGRpczQyMXZPRDU0Q1RSS0JsMEVwODh6UXJkV3hGR0oxODRzcE0rZkkyc0twWTMKbURNZXkyd0ZadXR5UU10M0VqSlRsWkFWRVVPc1JIcnZZV0N0ZzF5OURITXRmb29xeXpZZ0R5UWdHTTdoQWdNQgpBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lCcGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXCkJCU0RtSHkxWkM2TjhjUWp4SjdDY2djcGxqbkZoakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBWUVBSnkxYzBHZGcKVC9WTTBicExSbzUxYnVZUHZqMGFlenpKYWUweS9lMy8vVUptTmNBOCtIb2xhaFZhOXUxVE5GYzAxK1UwR1dLNQpJVUZFNWExdjVCdWlMOGJBRzhyV0JkeVJ3QkJJelRQVTdvRm9EblZuU1FOTXVYSVNUdTE0QS84NzVkK1crM0FYCnhLand6U0RHc0U0Wmp4Zy9vVnJDNDJZU3pFcW5ISkNpTGNsVWFzM1lzNWVTWjFQNEhvcTRhcjE0U05pK20xejkKVzNLb3R3Ly9PUU95dFJGcVhBc2ZrTkVMQ25rV2RONG1FWEdOVVJpZjdDTjJ4L05LQm9yU0dWa0ZtNjd1WWJqSgoxcDhHZTIwK3ZJZEdvR1d3Q2lLendLM0hiUHpVbS9FbDZLZVVzMVdIL0o1TFRZelNJU3Q1eldyZkl6amtSY1E2CkQ1OTdWN2NBQVlDL3dWWC9wdkdWeG1DR3J1aVY5QTRjTzhYNlVFaVZaUE1ubW5wUE9XVW1KV29PSklqYkFJakIKWGNkaWpHU1RtYzBDUmxIYjUxSGdYUkhNRCs0RXhyQzV0VFQ1NVF4R1l2SHZ4SzFCUDFsbDVhU1JHdHMyd1FoMAprbzN3eW4wUSt2OUhWMzRmVXZTc1doZ0NRdTdmcHl3WUVLQzBUNWdVYlNCQWRPeTA0TDkyemY3VwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==","server":"https://api.b84edf3.kyma.ondemand.com"},"name":"garden-kyma--b84edf3-external"}],"contexts":[{"context":{"cluster":"garden-kyma--b84edf3-external","user":"garden-kyma--b84edf3-external"},"name":"garden-kyma--b84edf3-external"}],"current-context":"garden-kyma--b84edf3-external","kind":"Config","users":[{"name":"garden-kyma--b84edf3-external","user":{"exec":{"apiVersion":"client.authentication.k8s.io/v1","args":["-c","set -e -o pipefail\nOIDC_URL_WITH_AUDIENCE=\"$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=gh-teched-76f46b5b-d9ab-486f-8e4f-12e1163af943\"\nIDTOKEN=$(curl -sS \\\n  -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n  -H \"Accept: application/json; api-version=2.0\" \\\n  \"$OIDC_URL_WITH_AUDIENCE\" | jq -r .value)\n# Print decoded token information for debugging purposes\necho ::debug:: JWT content: \"$(echo \"$IDTOKEN\" | jq -c -R 'split(\".\") | .[1] | @base64d | fromjson')\" \u003e\u00262\nEXP_TS=$(echo $IDTOKEN | jq -R 'split(\".\") | .[1] | @base64d | fromjson | .exp')\nEXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)\n# return token back to the credential plugin\ncat \u003c\u003c EOF\n{\n  \"apiVersion\": \"client.authentication.k8s.io/v1\",\n  \"kind\": \"ExecCredential\",\n  \"status\": {\n    \"token\": \"$IDTOKEN\",\n    \"expirationTimestamp\": \"$EXP_DATE\"\n  }\n}\nEOF\n"],"command":"bash","interactiveMode":"Never"}}}]}
        "method": "kubeconfig"

    - "name": "check permissions"
      "run": |
        cp $KUBECONFIG ./uk-xp264.yaml

        kubectl version
        kubectl config view
        kubectl config get-clusters

        export TOTO=$KUBECONFIG

        # https://able8.medium.com/how-to-merge-multiple-kubeconfig-files-into-one-36fc987c2e2f
        #
        export KUBECONFIG=:./uk-xp264.yaml:./xp264-000.yaml:./japanese-east.yaml:./us-east.yaml:./uk-south.yaml
        kubectl config view --flatten > all-in-one-kubeconfig.yaml
        export KUBECONFIG=$TOTO

        cp ./all-in-one-kubeconfig.yaml $KUBECONFIG
        cat $KUBECONFIG

        kubectl config get-clusters
        kubectl config get-contexts

        kubectl config use-context ${{ env.CLUSTER_CONTEXT }}
        kubectl config current-context

    - "name": "install kyma cli"
      uses: kyma-project/setup-kyma-cli@v1
      with:
        version: latest
    - "name": "use kyma cli"
      "run": |
         kyma -h
         kyma alpha -h
    - "name": "Diagnose cluster health and configuration."
      id: cluster_info
      "run": |
        echo "Diagnose cluster health and configuration...."

        kyma alpha diagnose -f json | jq -r '.metadata'
        #kyma alpha diagnose -f json | jq -r '.nodes'

        DEEPLINK=$(kyma alpha diagnose -f json | jq -r '.metadata | { deeplink: ("https://emea.cockpit.btp.cloud.sap/cockpit?idp=anuk8cmfw.accounts.ondemand.com#/globalaccount/" + .globalAccountID + "/subaccount/" + .subaccountID) } | .deeplink' )
        echo $DEEPLINK

        DEEPLINK2=$(kyma alpha diagnose -f json | jq -r '.metadata | { deeplink: ("https://emea.cockpit.btp.cloud.sap/cockpit/#/globalaccount/" + .globalAccountID + "/subaccount/" + .subaccountID) } | .deeplink' )
        echo $DEEPLINK2

        GLOBALACCOUNT=$(kyma alpha diagnose -f json | jq -r '.metadata.globalAccountID ' ) 
        echo $GLOBALACCOUNT

        echo "GLOBALACCOUNT=$GLOBALACCOUNT" >> $GITHUB_OUTPUT

    - name: Get short-lived GitHub-issued JWT
      id: get-github-jwt
      run: |
        #githubJwt=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" -H "Accept: application/json; api-version=2.0" -H "Content-Type: application/json" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://${{ github.event.inputs.IDP }}" | jq -r '.')
        #echo $githubJwt | base64
        githubJwt=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" -H "Accept: application/json; api-version=2.0" -H "Content-Type: application/json" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://${{ github.event.inputs.IDP }}" | jq -r '.value')

        EXP_TS=$(echo $githubJwt | jq -R 'split(".") | .[1] | @base64d | fromjson | .exp')
        echo $EXP_TS
        EXP_DATE=$(date -d @$EXP_TS --iso-8601=seconds)
        echo $EXP_DATE

        echo $githubJwt | jq -R 'split(".") | .[0],.[1] | @base64d | fromjson'
        echo "githubJwt=$githubJwt" >> $GITHUB_OUTPUT
          
    - name: Setup Terraform
      id : setup_terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false
        terraform_version: latest ## "1.9.8"

    - name: Terraform Init
      id: terraform_init
      shell: bash
      run: |
        wget -qO- https://ipecho.net/plain ; echo


        export KUBE_CONFIG_PATH=$KUBECONFIG

        export CONFIG_DIRECTORY=${{ env.CONFIG_DIRECTORY }}
        export TF_REGISTRY_CLIENT_TIMEOUT=30s
        export BTP_ASSERTION=${{steps.get-github-jwt.outputs.githubJwt}}

        echo ${{ secrets.CICD_TOKEN_FOR_TF_MODULES }} | base64
        echo ${{secrets.CICD_TOKEN_FOR_TF_MODULES}} | sed 's/./& /g'
        echo "machine github.com login ${{ env.CICD_REPO_USERNAME_FOR_TF_MODULES }} password ${{ env.CICD_TOKEN_FOR_TF_MODULES }}" > ~/.netrc
        cat ~/.netrc
        git config --global url.https://github.com/.insteadOf git://github.com/
        git config --global advice.detachedHead false

        terraform workspace select -or-create ${{ env.RUNTIME_WORKSPACE }} || echo "Workspace ${{ env.RUNTIME_WORKSPACE }} already exists or cannot be created"

        terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} init -upgrade -no-color
        export TF_WORKSPACE=${{ env.RUNTIME_WORKSPACE }}

      env:
        CICD_TOKEN_FOR_TF_MODULES: ${{ secrets.CICD_TOKEN_FOR_TF_MODULES }}
        CICD_REPO_USERNAME_FOR_TF_MODULES: ${{ vars.CICD_REPO_USERNAME_FOR_TF_MODULES }}

        RUNTIME_CONTEXT_WORKSPACE: "runtime-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        RUNTIME_WORKSPACE: "k8s-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        PROVIDER_WORKSPACE: "provider-context-${{steps.cluster_info.outputs.GLOBALACCOUNT}}" 

    - name: Terraform Apply 
      id: terraform_apply
      shell: bash
      run: |
        export TF_WORKSPACE=${{ env.RUNTIME_WORKSPACE }}
        export KUBE_CONFIG_PATH=$KUBECONFIG
        export CONFIG_DIRECTORY=${{ env.CONFIG_DIRECTORY }}
        export TF_REGISTRY_CLIENT_TIMEOUT=30s

        export BTP_ASSERTION=${{steps.get-github-jwt.outputs.githubJwt}}
        export BTP_GLOBAL_ACCOUNT=${{steps.cluster_info.outputs.GLOBALACCOUNT}}

        export TF_VAR_runtime_context_workspace=${{ env.RUNTIME_CONTEXT_WORKSPACE }}
  
        terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} ${{ env.RUNTIME_ACTION }} \
        -var BTP_GLOBAL_ACCOUNT=${{steps.cluster_info.outputs.GLOBALACCOUNT}} \
        -var BTP_CUSTOM_IDP=${{ github.event.inputs.IDP }} \
        -var BTP_SUBACCOUNT=${{ github.event.inputs.subaccount_name }} \
        -var POSTGRES_ALLOW_ACCESS=${{ vars.POSTGRES_ALLOW_ACCESS }} \
        -auto-approve -no-color

      env:
        RUNTIME_CONTEXT_WORKSPACE: "runtime-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        RUNTIME_WORKSPACE: "k8s-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        PROVIDER_WORKSPACE: "provider-context-${{steps.cluster_info.outputs.GLOBALACCOUNT}}" 

    # https://stackoverflow.com/questions/69925970/how-to-save-terraform-output-variable-into-a-github-action-s-environment-variabl
    - name: Terraform Output # https://docs.github.com/en/actions/reference/workflows-and-actions/contexts#steps-context
      id: terraform_output
      shell: bash
      run: |
        terraform workspace select ${{ env.RUNTIME_WORKSPACE }}
        export TF_WORKSPACE=${{ env.RUNTIME_WORKSPACE }}
        export CONFIG_DIRECTORY=${{ env.CONFIG_DIRECTORY }}

        export BTP_ASSERTION=${{steps.get-github-jwt.outputs.githubJwt}}
        terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} state list
        terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} output

        kubeconfig_sa=$(terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} output -raw kubeconfig-sa)
        terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} output -json kyma_parameters > ./tf_output.json
        kyma_parameters=$(terraform -chdir=${{ env.PATH_TO_TFSCRIPT }} output -json kyma_parameters | jq -R)

        echo $kyma_parameters
        echo "kyma_parameters=$kyma_parameters" >> $GITHUB_OUTPUT
        
        ls -al $CONFIG_DIRECTORY
        cat $CONFIG_DIRECTORY/cis-secret.json

      env:
        RUNTIME_CONTEXT_WORKSPACE: "runtime-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        RUNTIME_WORKSPACE: "k8s-context-${{ inputs.subaccount_name }}-${{steps.cluster_info.outputs.GLOBALACCOUNT}}"
        PROVIDER_WORKSPACE: "provider-context-${{steps.cluster_info.outputs.GLOBALACCOUNT}}" 

#    - name: json2html
#      id: json2html
#      uses: Enovade/json2html@v0.2.3
#      with:
#        json: ${{ steps.terraform_output.outputs.kyma_parameters }}

#    - name: Convert JSON to HTML Table
#      uses: Teebra/JSON-to-HTML-table@v2.0.0
#      with:
#        json-file: ./tf_output.json  # Specify the path to your JSON file

#    - name: Upload HTML Table to Artifacts
#      uses: actions/upload-artifact@v4
#      with:
#        name: output_html 
#        path: output.html # The created file's name is output.html. Name cannot be changed


#    - name: Terraform Results
#      id: terraform_results
#      shell: bash
#      run: |

#        echo "htmloutput"
#        echo ${{ steps.json2html.outputs.htmloutput }}

"name": "k8s-data-context-teched"

"permissions":
  "contents": "read"
  "id-token": "write"
